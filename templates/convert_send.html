<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Upload Order (Convert & Send)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <style>
      textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>
  <body class="p-4">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <h4 class="mb-0">Upload Order (Convert & Send)</h4>
        <div class="d-flex gap-2">
          <a href="/" class="btn btn-outline-secondary" title="Home">üè†</a>
          <a href="/logout" class="btn btn-outline-danger" title="Logout">‚éã</a>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <form id="frmUpload" class="mb-3">
            <div class="row g-3 align-items-end">
              <div class="col-md-8">
                <label class="form-label">Pilih file Excel (.xlsx)</label>
                <input id="fileInput" type="file" class="form-control" accept=".xlsx" required />
              </div>
              <div class="col-md-4 d-flex align-items-center gap-2">
                <button id="btnProcess" type="submit" class="btn btn-primary w-100">Upload, Convert & Send</button>
                <div id="loading" class="spinner-border text-primary d-none" role="status" style="width: 1.5rem; height: 1.5rem;"><span class="visually-hidden">Loading...</span></div>
              </div>
            </div>
          </form>

          <div class="mb-3">
            <label class="form-label">Hasil Konversi (JSON)</label>
            <textarea id="txtJson" class="form-control" rows="14" readonly placeholder="Hasil JSON akan muncul di sini..."></textarea>
          </div>

          <div class="alert alert-info">
            File yang diupload akan dinamai ulang menjadi <code>template_feed_order.xlsx</code> sebelum dikonversi.
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Info -->
    <div class="modal" tabindex="-1" id="modalInfo">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Informasi Proses</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <pre id="modalMessage" class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const frmUpload = document.getElementById('frmUpload');
      const fileInput = document.getElementById('fileInput');
      const btnProcess = document.getElementById('btnProcess');
      const loading = document.getElementById('loading');
      const txtJson = document.getElementById('txtJson');
      const modalEl = document.getElementById('modalInfo');
      const modal = new bootstrap.Modal(modalEl);
      const modalMessage = document.getElementById('modalMessage');

      frmUpload.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!fileInput.files || fileInput.files.length === 0) {
          alert('Pilih file .xlsx terlebih dahulu');
          return;
        }
        loading.classList.remove('d-none');
        btnProcess.disabled = true;
        txtJson.value = '';
        modalMessage.textContent = '';
        try {
          const fd = new FormData();
          fd.append('file', fileInput.files[0]);
          const res = await fetch('/api/convert-send', { method: 'POST', body: fd });
          const ct = res.headers.get('content-type') || '';
          let data;
          if (ct.includes('application/json')) { data = await res.json(); } else { data = { status: res.status, message: await res.text() }; }
          if (data && data.converted_json) {
            txtJson.value = JSON.stringify(data.converted_json, null, 2);
          }
          const msgs = [];
          if (data && data.steps) { data.steps.forEach(s => msgs.push(`[${s.status}] ${s.message}`)); }
          if (data && data.message) { msgs.push(data.message); }
          modalMessage.textContent = msgs.join('\n') || 'Selesai.';
          modal.show();
        } catch (err) {
          modalMessage.textContent = 'Terjadi error saat memproses: ' + (err && err.message ? err.message : String(err));
          modal.show();
        } finally {
          loading.classList.add('d-none');
          btnProcess.disabled = false;
          frmUpload.reset();
        }
      });
    </script>
  </body>
</html>


