<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Update Lokasi Customer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  </head>
  <body class="p-4">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <h4 class="mb-0">Update Lokasi Customer</h4>
        <a href="/" class="btn btn-outline-secondary" title="Home">üè†</a>
      </div>

      <div class="row g-3 align-items-end mb-3">
        <div class="col-md-4">
          <label class="form-label">Warehouse</label>
          <select id="warehouse" class="form-select">
            <option value="">-- Pilih Warehouse --</option>
            {% for wid, wname in warehouses %}
            <option value="{{ wid }}">{{ wid }} - {{ wname }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-5">
          <label class="form-label">Nomor Faktur</label>
          <input id="faktur" type="text" class="form-control" placeholder="Contoh: G04SI2505-0180" />
        </div>
        <div class="col-md-3">
          <div class="d-flex align-items-center gap-2">
            <button id="btnCari" class="btn btn-primary w-100">Cari</button>
            <div id="loading" class="spinner-border text-primary d-none" role="status" style="width: 1.5rem; height: 1.5rem;"><span class="visually-hidden">Loading...</span></div>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="tblOrders">
          <thead>
            <tr>
              <th>faktur_date</th>
              <th>faktur_id</th>
              <th>order_id</th>
              <th>warehouse_id</th>
              <th>mst_location_child_id</th>
              <th>code</th>
              <th>name</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="mt-3">
        <button id="btnUbahLokasi" class="btn btn-warning" disabled>Ubah Lokasi</button>
      </div>
    </div>

    <!-- Modal Ubah Lokasi -->
    <div class="modal" tabindex="-1" id="modalLokasi">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Pilih Lokasi Baru</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Lokasi</label>
          <input id="searchLokasi" type="text" class="form-control mb-2" placeholder="Ketik untuk mencari (id / code / name)" />
            <select id="ddlLokasi" class="form-select"></select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            <button id="btnSaveLokasi" type="button" class="btn btn-primary">Simpan</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const tblBody = document.querySelector('#tblOrders tbody');
      const btnCari = document.getElementById('btnCari');
      const btnUbah = document.getElementById('btnUbahLokasi');
      const faktur = document.getElementById('faktur');
      const warehouse = document.getElementById('warehouse');
      const modalEl = document.getElementById('modalLokasi');
      const modal = new bootstrap.Modal(modalEl);
      const ddlLokasi = document.getElementById('ddlLokasi');
      const searchLokasi = document.getElementById('searchLokasi');

      let currentFaktur = '';

      function renderRows(rows){
        tblBody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          ['faktur_date','faktur_id','order_id','warehouse_id','mst_location_child_id','code','name']
            .forEach(k => {
              const td = document.createElement('td');
              td.textContent = r[k] ?? '';
              tr.appendChild(td);
            });
          tblBody.appendChild(tr);
        });
        btnUbah.disabled = rows.length === 0;
      }

      const loading = document.getElementById('loading');
      btnCari.addEventListener('click', async () => {
        const w = warehouse.value.trim();
        const f = faktur.value.trim();
        if(!w || !f){
          alert('Pilih warehouse dan isi nomor faktur');
          return;
        }
        currentFaktur = f;
        loading.classList.remove('d-none');
        try {
          const res = await fetch(`/api/orders?warehouse_id=${encodeURIComponent(w)}&faktur_id=${encodeURIComponent(f)}`);
          const json = await res.json();
          renderRows(json.data || []);
        } finally {
          loading.classList.add('d-none');
        }
      });

      let allLocations = [];
      function renderLocationOptions(list){
        ddlLokasi.innerHTML = '';
        list.forEach(x => {
          const opt = document.createElement('option');
          opt.value = x.mst_location_child_id;
          opt.textContent = `${x.mst_location_child_id} - ${x.code} - ${x.name}`;
          ddlLokasi.appendChild(opt);
        });
      }

      btnUbah.addEventListener('click', async () => {
        // load lokasi list (cache per open)
        const res = await fetch('/api/locations');
        const json = await res.json();
        allLocations = json.data || [];
        renderLocationOptions(allLocations);
        searchLokasi.value = '';
        modal.show();
      });

      searchLokasi.addEventListener('input', () => {
        const q = searchLokasi.value.trim().toLowerCase();
        if(!q){ renderLocationOptions(allLocations); return; }
        const filtered = allLocations.filter(x => {
          return String(x.mst_location_child_id).toLowerCase().includes(q)
            || String(x.code ?? '').toLowerCase().includes(q)
            || String(x.name ?? '').toLowerCase().includes(q);
        });
        renderLocationOptions(filtered);
      });

      document.getElementById('btnSaveLokasi').addEventListener('click', async () => {
        const val = parseInt(ddlLokasi.value, 10);
        if(!currentFaktur || Number.isNaN(val)){
          alert('Data tidak valid');
          return;
        }
        const res = await fetch('/api/orders/update-location', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ faktur_id: currentFaktur, customer_id: val })
        });
        const json = await res.json();
        if(json.status === 200){
          alert('Lokasi berhasil diubah');
          modal.hide();
        } else {
          alert('Gagal mengubah lokasi');
        }
      });
    </script>
  </body>
  </html>


